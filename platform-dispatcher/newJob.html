<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create New Job</title>

    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../assets/css/all.min.css" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar">
      <div class="logo"><span>LS</span> LockSmith Platform</div>

      <div class="nav-links" id="navLinks">
        <a href="dashboard.html"><i class="fa fa-house"></i> Dashboard</a>
        <a href="newJob.html" class="active"
          ><i class="fa fa-plus"></i> New Job</a
        >
        <a href="jobHistory.html"
          ><i class="fa-solid fa-list-ul"></i> Job History</a
        >
        <a href="dispatcherCompanies.html"
          ><i class="fa-regular fa-map"></i> Companies</a
        >
        <a href="customers.html">Customers</a>
      </div>

      <div class="profile"><i class="fa fa-user"></i> Dispatcher</div>
      <div class="toggle-sidebar" id="toggleSidebar">
        <i class="fa fa-bars"></i>
      </div>
    </nav>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <a href="dashboard.html"><i class="fa fa-house"></i> Dashboard</a>
      <a href="newJob.html" class="active"
        ><i class="fa fa-plus"></i> New Job</a
      >
      <a href="jobHistory.html"
        ><i class="fa-solid fa-list-ul"></i> Job History</a
      >
      <a href="dispatcherCompanies.html"
        ><i class="fa-regular fa-map"></i> Companies</a
      >
      <a href="customers.html">Customers</a>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="mainContent">
      <!-- HEADER -->
      <div class="header">
        <div>
          <h1>Create New Job</h1>
          <p>Fill in the details to create a new service job</p>
        </div>
      </div>

      <!-- FORM -->
      <form id="newJobForm" class="job-form-wrapper">
        <!-- ================= Customer Information ================= -->
        <div class="form-card">
          <div class="form-card-header">
            <div class="form-title">
              <i class="fa-regular fa-user"></i>
              <div>
                <h3>Customer Information</h3>
                <p>Select an existing customer or add a new one</p>
              </div>
            </div>
          </div>

          <div class="form-card-body">
            <label class="required">Customer</label>

            <div class="customer-row">
              <select id="customerSelect" class="form-input">
                <option value="">Search customer by name or phone</option>
              </select>

              <button
                type="button"
                class="btn-add"
                data-bs-toggle="modal"
                data-bs-target="#addCustomerModal">
                <i class="fa fa-plus"></i> Add New
              </button>
            </div>
          </div>
        </div>

        <!-- ================= Item Information ================= -->
        <div class="form-card">
          <div class="form-card-header">
            <div class="form-title">
              <i class="fa-solid fa-cube"></i>
              <div>
                <h3>Item Information</h3>
                <p>Select the type of item and specify details</p>
              </div>
            </div>
          </div>

          <div class="form-card-body d-flex flex-column">
            <label class="required">Item Type</label>
            <select id="itemType" class="form-input">
              <option value="Door">Door</option>
              <option value="Car">Car</option>
            </select>
            <p>Please select a customer first</p>
          </div>
        </div>

        <!-- ================= Job Details ================= -->
        <div class="form-card">
          <div class="form-card-header">
            <div class="form-title">
              <i class="fa-regular fa-calendar"></i>
              <div>
                <h3>Job Details</h3>
                <p>Specify service type, priority, and schedule</p>
              </div>
            </div>
          </div>

          <div class="form-card-body flex-row">
            <div class="flex-col-50">
              <label class="required">Service Type</label>
              <select id="serviceType" class="form-input">
                <option value="">Select service type</option>
                <option>Lock Installation</option>
                <option>Lock Repair</option>
              </select>
            </div>

            <div class="flex-col-50">
              <label class="required">Priority</label>
              <select id="priority" class="form-input">
                <option value="Normal">Normal</option>
                <option value="Urgent">Urgent</option>
              </select>
            </div>

            <div class="flex-col-100">
              <label>Scheduled Date & Time</label>
              <input
                type="datetime-local"
                id="scheduledAt"
                class="form-input"
              />
            </div>

            <div class="flex-col-100">
              <label>Notes</label>
              <textarea
                id="notes"
                class="form-textarea"
                placeholder="Additional information about the job..."
              ></textarea>
            </div>
          </div>
        </div>

        <!-- ================= Actions ================= -->
        <div class="form-actions">
          <button type="button" id="cancelBtn" class="btn-cancel">
            Cancel
          </button>
          <button type="button" id="createBtn" class="btn-primary-action">
            Create Job
          </button>
        </div>
      </form>
    </main>

    <!-- =================ADD CUSTOMER MODAL ================= -->
    <div
      class="modal fade"
      id="addCustomerModal"
      tabindex="-1"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <!-- Header -->
          <div class="modal-header">
            <h5 class="modal-title">Add New Customer</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"></button>
          </div>

          <!-- Body -->
          <div class="modal-body">
            <p class="text-muted mb-3">Enter the customer's details below.</p>

            <div class="mb-3">
              <label for="newCustomerName" class="form-label required">Full Name</label>
              <input
                type="text"
                class="form-control"
                id="newCustomerName"
                placeholder="e.g. John Smith"/>
            </div>

            <div class="mb-3">
              <label for="newCustomerPhone" class="form-label required"
                >Phone Number</label>
              <input
                type="tel"
                class="form-control"
                id="newCustomerPhone"
                placeholder="e.g. 555-0123"/>
            </div>

            <div class="mb-3">
              <label for="newCustomerAddress" class="form-label required">Address</label>
              <input
                type="text"
                class="form-control"
                id="newCustomerAddress"
                placeholder="e.g. 123 Market St, San Francisco"/>
            </div>
          </div>

          <!-- Footer -->
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-light border"
              data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="button" id="saveCustomerBtn" class="btn btn-primary">
              Add Customer
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="../assets/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>

      <!-- Internal Js -->
      <script>
      document.addEventListener("DOMContentLoaded", function () {
        /* ================= Elements ================= */
        const form = document.getElementById("newJobForm");

        const customerSelect = document.getElementById("customerSelect");
        const itemType = document.getElementById("itemType");
        const serviceType = document.getElementById("serviceType");
        const priority = document.getElementById("priority");

        const cancelBtn = document.getElementById("cancelBtn");
        const createBtn = document.getElementById("createBtn");

        // Modal elements
        const saveCustomerBtn = document.getElementById("saveCustomerBtn");
        const newCustomerName = document.getElementById("newCustomerName");
        const newCustomerPhone = document.getElementById("newCustomerPhone");
        const newCustomerAddress =
        document.getElementById("newCustomerAddress");
        const addCustomerModalEl = document.getElementById("addCustomerModal");

        const addCustomerModal = new bootstrap.Modal(addCustomerModalEl);

        /* ================= Navigation ================= */

        cancelBtn.addEventListener("click", () => {
          window.location.href = "dashboard.html";
        });

    createBtn.addEventListener("click", () => {
    if (!validateForm()) return;
     // Show success alert
    alert("Job added successfully");
    window.location.href = "jobHistory.html";
    });
        /* ================= Add Customer Logic ================= */

        saveCustomerBtn.addEventListener("click", () => {
          const name = newCustomerName.value.trim();
          const phone = newCustomerPhone.value.trim();
          const address = newCustomerAddress.value.trim();

          if (!name || !phone || !address) {
            alert("Please fill in all customer fields.");
            return;
          }

          // Prevent duplicates by phone
          const exists = [...customerSelect.options].some((opt) =>
            opt.textContent.includes(phone),
          );

          if (exists) {
            alert("Customer already exists.");
            return;
          }

          // Create option
          const option = document.createElement("option");
          option.value = phone;
          option.textContent = `${name} (${phone})`;

          customerSelect.appendChild(option);
          customerSelect.value = phone;

          // Reset inputs
          newCustomerName.value = "";
          newCustomerPhone.value = "";
          newCustomerAddress.value = "";

          // Close modal
          addCustomerModal.hide();
        });

        // Autofocus first input when modal opens
        addCustomerModalEl.addEventListener("shown.bs.modal", () => {
          newCustomerName.focus();
        });

        /* ================= Validation System ================= */

        const requiredFields = [
          { el: customerSelect, name: "Customer" },
          { el: itemType, name: "Item Type" },
          { el: serviceType, name: "Service Type" },
          { el: priority, name: "Priority" },
        ];

        function showError(input, message) {
          input.classList.add("input-error");

          let error = input.parentElement.querySelector(".error-text");
          if (!error) {
            error = document.createElement("div");
            error.className = "error-text";
            error.innerText = message;
            input.parentElement.appendChild(error);
          }

          error.style.display = "block";
        }

        function clearError(input) {
          input.classList.remove("input-error");
          const error = input.parentElement.querySelector(".error-text");
          if (error) error.style.display = "none";
        }

        function validateForm() {
          let isValid = true;

          requiredFields.forEach((field) => {
            if (!field.el.value || field.el.value.trim() === "") {
              showError(field.el, `${field.name} is required`);
              isValid = false;
            } else {
              clearError(field.el);
            }
          });

          return isValid;
        }

        /* ================= Form Submit ================= */

        form.addEventListener("submit", function (e) {
          e.preventDefault();

          if (!validateForm()) {
            const firstError = document.querySelector(".input-error");
            if (firstError) {
              firstError.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
            }
            return;
          }

          alert("Job Created Successfully");
          form.reset();
        });

        /* ================= Live Validation ================= */

        requiredFields.forEach((field) => {
          field.el.addEventListener("change", () => {
            if (field.el.value) {
              clearError(field.el);
            }
          });
        });
      });
    </script>
  </body>
</html>
